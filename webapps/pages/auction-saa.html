<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="auction-saa-table.html">
<link rel="import" href="utils.html">
<link rel="import" href="native-post.html">
<link rel="import" href="native-timer.html">



<polymer-element name="auction-saa">
  <template>
    <link rel="stylesheet" href="./auction-saa.css" type="text/css" />
    
    <!-- <core-ajax
      id="submit"
      url="/WEB-INF/bid.xml"
      method="POST"
      handleAs="xml"
      params="{{ data }}"
      on-core-response="{{ handleResponse }}"
    ></core-ajax> -->

    <native-post
      id="submit"
      url="/WEB-INF/bid.xml"
      params="{{ data }}"
      success="{{ handleResponse }}"      
      fail="{{ fail }}"
    ></native-post>

    <!-- <native-timer id="timer"></native-timer> -->

    <core-ajax
      id="period"
      url="{{ updateUrl }}"
      handleAs="xml"
      on-core-response="{{ update }}"
    ></core-ajax>

    <!-- <core-xhr id="xhr"></core-xhr> -->


    <div id="auction-saa">
      <p>Round {{ round }}</p>
      <p id="time"></p>
      <auction-saa-table id="table" items="{{ items }}" final="{{ isFinal }}"></auction-saa-table>
      <button id="bid" on-click="{{submit}}">Bid</button>
    </div>



  </template>

  <script>
    Polymer('auction-saa', {
      localIP: "127.0.0.1",
      username: "",
      saa: {},

      round: -1,
      timeRemain: -1,
      minimumIncreament: -1,
      items: undefined,
      isFinal: false,
      data: "",
      isTimerStarted: false,

      updateUrl: "",
      timer: undefined,

      setUp: function(username, localIP) {
        this.username = username;
        this.localIP = localIP;

        this.updateUrl = "/WEB-INF/update.xml?name=" + this.username + "&ip=" + this.localIP;
      },

      setData: function(data) {
        console.log("saa.getData", data);
        this.saa = data;
        this.updateInfomation();

        // start ajax timer
        var self = this;
        if ( this.isTimerStarted == false ) {
          this.timer = setInterval(function() {
            self.$.period.go()
          }, 1000);
          this.isTimerStarted = true;
        }
      },

      update: function(e) {
        console.log("update!!", e, e.detail, e.detail.xhr);

        var xml = e.detail.xhr.response; 
        var x2js = new X2JS();
        var json = x2js.xml_str2json(xml);

        this.setData(json);
      },


      updateInfomation: function() {
        var tmp = this.saa.auction_context.item
        if ( this.items != undefined ) {
          var values = this.$.table.getValues();
          for ( i=0; i<tmp.length; i++ ) {
            tmp[i]._value = values[i];
          }
        } else {
          for ( i=0; i<tmp.length; i++ ) {
            tmp[i]._value = "";
          }
        }
        this.items = tmp;
        this.round = this.saa.auction_context.round._value;
        this.timeRemain = this.saa.auction_context.duration._remain;
        this.minimumIncreament = this.saa.auction_context.minimum_increament._value;

        this.isFinal = this.saa.auction_context.round._final == "no" ? false : true;

        this.$.bid.disabled = false;
        if ( ! this.isAuctionStarted() ) {
          this.$.time.innerHTML = "Please wait, auction haven't started yet.";
          // this.$.bid.disabled = true;
          // not stated yet
        } else {
         if ( ! this.isFinal  ) {
            this.$.time.innerHTML = "Time remain: " + this.timeRemain + "s";
            
            // final
          } else {
            this.$.time.innerHTML = "<b>Final</b>";
            this.$.bid.disabled = true;
          }
        }
        console.log(this.items);
      },

      isAuctionStarted: function() {
        if ( this.saa.auction_context.round._value == "0" ) {
          return false
        }
        return true;
      },

      submit: function() {
        // validate
        // collect data
        this.data = this.collectData();

        // console.log("submit", this.data);


        // this.$.xhr.request({
        //   url: "/WEB-INF/bid.xml",
        //   method: "POST",
        //   params: this.data,
        //   responseType: "xml",
        //   callback: this.handleResponse
        // });

        // this.$.submit.go();

        // this.$.submit.go();

        this.$.period.go();


      },

      collectData: function() {
        var x2js = new X2JS();
        var data = {};
        data.bid = {};
        data.bid.bidder = {_name: this.username, _ip: this.localIP};
        data.bid.item_list = {}
        data.bid.item_list.item = this.$.table.getItems();
        
        return x2js.json2xml(data);
      }, 

      handleResponse: function(e) {
        // var xml = e.detail.xhr.response;
        console.log("ok", e);
      },

      fail: function(e) {
        console.log("fail", e);
      }
    });
  </script>
</polymer-element>
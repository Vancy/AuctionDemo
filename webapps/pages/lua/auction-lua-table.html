<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="auction-lua-table" attributes="items final">
  <template>
    <link rel="stylesheet" href="./auction-lua-table.css" />

    <div class="panel panel-default">
        <table id="bidTable" class="table table-hover">
          <thead>
            <th>Item</th>
	    <th>Price</th>
            <th>Licensed</th> 
	    <th>Unlicensed</th>         
          </thead>

          <tbody id="tbody">
            <template repeat="{{ item in items }}">     
              <tr>
                <td>{{ item.name }}</td>
                <td id="price{{item.ID}}">{{ item.price }}</td> 
                <td><button id="license_price{{item.ID}}" on-click="{{bid}}" type="button" class="btn btn-default">Bid</button></td> 
	        <td><button id="unlicense_price{{item.ID}}" on-click="{{bid}}" type="button" class="btn btn-default">Bid</button></td> 
              </tr>
            </template>
          </tbody>
        </table>
    </div>

  </template>

  <script>
    Polymer('auction-lua-table', {
      lua: {},
      items: [],
      minIncrement: 0,
      clockTick: undefined,

      startAuction: function(lua_context) {
	console.log("table start");
	this.lua = lua_context;
	this.items = this.lua.itemList;
        var tickDuration = this.lua.duration_ms;
  	this.minIncrement = this.lua.minIncreament;
        var self = this;
        this.clockTick = setInterval(function() {
          self.updatePrice()
        }, tickDuration);
      },

      updatePrice() {
        for (i=0; i < this.items.length; i++) {
	  var id = this.items[i].ID;
	  var currentPrice = parseInt(this.$.tbody.querySelector("#price" + id).innerHTML);
          var maxPrice = this.items[i].maxPrice;
	  var nextPrice = currentPrice;
	  if (currentPrice < maxPrice) {
	    nextPrice += this.minIncrement;
	    if (nextPrice > maxPrice) {
		nextPrice = maxPrice;
	    }
	  }
	  console.log("id:" + id + "currentPrice:" + currentPrice + "nextPrice:" + nextPrice);
	  this.$.tbody.querySelector("#price" + id).innerHTML = nextPrice;
	}
	console.log("update price");
      },

      getItems: function() {
        var itemList = [];
        for ( i=0; i < this.items.length; i++ ) {
          var bid = {};
          bid.ID = this.items[i].ID;
          bid.name = this.items[i].name;
          bid.quantity_required = testAndSet(this, bid.ID, this.items[i].amount);
          bid.owners = {};
          itemList[i] = bid;
        }
        return itemList;

        function testAndSet(self, id, amount) {
          var yamount = self.$.tbody.querySelector("#yamount" + id).value;
          var re = /^[0-9]+$/;
          if ( ! re.test(yamount)  ||  parseInt(amount) > parseInt(yamount) ) {
            return "0";
          } else {
            return yamount;
          }
        }
      },

      update: function(newItems) {
        // helper functions
        function S2N(str) {
	  var re = /^[0-9]+$/;
          if ( !re.test(str) || (str == null)) {
	    return 0;
          }
          return parseInt(str);
        }

        function N2S(number) {
          if ( typeof number == "number" ) {
            return number.toString();
          }
          return number;
        }

        function showTips(tip, str) {
          tip.innerHTML = str;
          tip.style.display = "block";
          
        }

        function hideTips(tip) {
          tip.style.display = "none";
          
        }
      }

    });
  </script>
</polymer-element>

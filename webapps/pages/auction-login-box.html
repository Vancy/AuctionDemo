<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="utils.html">

<polymer-element name="auction-login-box">
  <template>
    <link rel="stylesheet" href="./auction-login-box.css" type="text/css" />

    <!-- Get IP address. Called only once. -->
    <core-ajax
      auto
      url="http://jsonip.com"
      handleAs="json"
      on-core-response="{{ getIP }}"
    ></core-ajax>

    <!-- Login --> 
    <core-ajax
      id="submit"
      url="{{ requestUrl }}"
      handleAs="xml"
      on-core-response="{{ handleResponse }}"
    ></core-ajax>

    <div id="auction-login-box">
      <div class="title">
        <p>Auction System</p>
      </div>
      <div id="box">
        <p id="login_tips" class="login_tips"></p>
        <div>
          <input type="text" id="name" value="{{ username }}" placeholder="please enter your name" on-keypress="{{keypressHandler}}" autofocus/>
          <label for="name"><i>Enter your name</i></lable>
        </div>
        
        <div id="div-btn-login">
          <button class="btn"  id="btn-login" on-click="{{onClick}}">Enter</button>
          <span>{{ localIP }}</span>
        </div>
        
    </div>



  </template>

  <script>
    Polymer('auction-login-box', {
      localIP : "127.0.0.1",
      requestUrl : "",

      getIP: function(e) {
        this.localIP = e.detail.response.ip;
      },

      handleResponse: function(e) {
        var json = JSON.parse(e.detail.xhr.response);
        this.switchTo(json);
      },

      onClick: function() {
        this.requestUrl = "/WEB-INF/login.xml?name=" + this.username + "&ip=" + this.localIP;
        console.log("on-click", this.requestUrl);
        this.$.submit.go();
      },

      switchTo: function(json) {
        // console.log(json, json.type);
        var type = json.type;
        if ( type == "SAA" ) {
          var saa = document.querySelector("#saa");
          saa.hidden = false;
          this.hidden = true;

          console.log("SAA -->", this.username, this.localIP);
          console.log("SAA: ", json);
          saa.setUp(this.username, this.localIP);
          saa.setData(json);
        } else if ( type == "CCA" ) {
          // for CCA
        } else {
          // Error
        }
      },

      keypressHandler: function(event, detail, sender) {
        // 13 means `Enter` key
        if ( event.keyCode == 13 ) {
          this.onClick();
        }
      }

    });
  </script>
</polymer-element>
<link rel="import" href="bower_components/polymer/polymer.html">

<polymer-element name="auction-saa-table" attributes="items final">
  <template>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
    <style>
      .panel {
          margin: auto;
          width: 400px;
      }
      .tip {
        display: none;
      }
    </style>

    <div class="panel panel-default">
      <!-- <div class="panel-heading">SAA</div> -->
        <table class="table table-hover">
          <thead>
            <th>Item</th>
            <th>Price</th> 

            <template if="{{ final }}">
              <th>Owner</th> 
            </template>

            <template if="{{ ! final }}">
              <th>Your Price</th>
            </template>           
          </thead>

          <!-- items here -->
          <tbody id="tbody">
            <template repeat="{{ item in items }}">     
              <tr>
                <td>{{ item.name }}</td>
                <td id="price{{item.ID}}">{{ item.price }}</td> 
        
                <template if="{{ final }}">
                  <td id="owner{{item.ID}}">
                    <template if="{{ item.owners.name != undefined }}">
                      {{ item.owners.name }}
                    </template>
                    <template if="{{ item.owners.name == undefined }}">
                      unknown
                    </template>
                  </td> 
                </template>

                <template if="{{ ! final }}">
                  <td>
                    <input id="yprice{{item.ID}}" type="text" class="form-control" on-keyup="{{validate}}">
                    <p id="yprice_tips{{item.ID}}" class="tips"></p>
                  </td>
                </template>
              </tr>
            </template>
          </tbody>
        </table>
      <!-- </div> -->
    </div>

  </template>

  <script>
    Polymer('auction-saa-table', {
      items: [],

      getItems: function() {
        //validate
        var itemList = [];
        for ( i=0; i < this.items.length; i++ ) {
          var bid = {};
          bid.ID = this.items[i].ID;
          bid.name = this.items[i].name;
          bid.price = this.$.tbody.querySelector("#yprice" + bid.ID).value;
          bid.owners = {};

          itemList[i] = bid;
        }
        return itemList;
      },

      update: function(newItems) {
        for ( i=0; i < newItems.length; i++ ) {
          var id = newItems[i].ID;
          this.$.tbody.querySelector("#price" + id).innerHTML = newItems[i].price;
        }
      },

      // for now, it simply try to validate all the input
      // later I will improve it
      //  1. addEventListener   2. auction-input
      validate: function() {
        for ( i=0; i < this.items.length; i++ ) {
          id = this.items[i].ID;
          price = this.items[i].price;
          yprice = this.$.tbody.querySelector("#yprice" + id).value;
          tips = this.$.tbody.querySelector("#yprice_tips" + id)

          if ( N2S(yprice).length != 0 ) {
            var re = /^[0-9]+$/;
            if ( ! re.test(yprice) ) {
              tips.innerHTML = "please enter a positive number";

            }

            if ( S2N(price) > S2N(yprice) ) {
              tips.innerHTML = "you are aborting this bid";
            }
          } else {
            tips.innerHTML = "";
          }
        }

        function S2N(str) {
          return parseInt(str);
        }

        function N2S(number) {
          if ( typeof number == "number" ) {
            return number.toString();
          }
          return number;
        }
      }
    });
  </script>
</polymer-element>
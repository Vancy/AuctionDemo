<link rel="import" href="bower_components/polymer/polymer.html">

<polymer-element name="auction-cca-table" attributes="items final">
  <template>
    <link rel="stylesheet" href="./auction-cca-table.css" />

    <div class="panel panel-default">
        <table id="bidTable" class="table table-hover">
          <thead>
            <th>Item</th>
            <th>Price</th>
            <th>Amount</th> 

            <template if="{{ final }}">
              <th>Owner</th> 
            </template>

            <template if="{{ ! final }}">
              <th>Your Amount</th>
            </template>           
          </thead>

          <tbody id="tbody">
            <template repeat="{{ item in items }}">     
              <tr>
                <td>{{ item.name }}</td>
                <td id="price{{item.ID}}">{{ item.price }}</td> 
                <td id="amount{{item.ID}}">{{ item.quantity }}</td> 
        
                <template if="{{ final }}">
                  <td id="owner{{item.ID}}">
                    <template if="{{ item.owner != undefined }}">
                      {{ item.owner.name }}
                    </template>
                    <template if="{{ item.owner == undefined }}">
                      unknown
                    </template>
                  </td> 
                </template>

                <template if="{{ ! final }}">
                  <td>
                    <input id="yamount{{item.ID}}" type="text" class="form-control" on-keyup="{{validate}}">
                    <p id="yamount_tips{{item.ID}}" class="tips"></p>
                  </td>
                </template>
              </tr>
            </template>
          </tbody>
        </table>
    </div>

  </template>

  <script>
    Polymer('auction-cca-table', {
      items: [],

      getItems: function() {
        var itemList = [];
        for ( i=0; i < this.items.length; i++ ) {
          var bid = {};
          bid.ID = this.items[i].ID;
          bid.name = this.items[i].name;
          bid.quantity_required = testAndSet(this, bid.ID, this.items[i].amount);
          bid.owners = {};
          itemList[i] = bid;
        }
        return itemList;

        function testAndSet(self, id, amount) {
          var yamount = self.$.tbody.querySelector("#yamount" + id).value;
          var re = /^[0-9]+$/;
          if ( ! re.test(yamount)  ||  parseInt(amount) > parseInt(yamount) ) {
            return "0";
          } else {
            return yamount;
          }
        }
      },

      update: function(newItems) {
        // for ( i=0; i < newItems.length; i++ ) {
        //   var id = newItems[i].ID;
        //   this.$.tbody.querySelector("#amount" + id).innerHTML = newItems[i].price;
        // }
      },

      // until now, it simply tries to validate all the input
      // later I will improve it
      //  1. addEventListener   2. auction-input
      validate: function() {
        for ( i=0; i < this.items.length; i++ ) {
          id = this.items[i].ID;
          amount = this.items[i].quantity;
          yamount = this.$.tbody.querySelector("#yamount" + id).value;
          tips = this.$.tbody.querySelector("#yamount_tips" + id);

          hideTips(tips);
          if ( N2S(yamount).length != 0 ) {
            var re = /^[0-9]+$/;
            if ( ! re.test(yamount) ) {
              showTips(tips, "please enter a positive number");
            }
            if ( S2N(amount) < S2N(yamount) ) {
              showTips(tips, "too much");
            }
          }
        } 

        // helper functions
        function S2N(str) {
          return parseInt(str);
        }

        function N2S(number) {
          if ( typeof number == "number" ) {
            return number.toString();
          }
          return number;
        }

        function showTips(tip, str) {
          tip.innerHTML = str;
          tip.style.display = "block";
          
        }

        function hideTips(tip) {
          tip.style.display = "none";
          
        }
      }

    });
  </script>
</polymer-element>
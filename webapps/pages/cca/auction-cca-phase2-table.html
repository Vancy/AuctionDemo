<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../utils/native-post.html">



<polymer-element name="auction-cca-phase2-table" attributes="items">
  <template>
    <link rel="stylesheet" href="./auction-cca-phase2-table.css" type="text/css" />

    <div class="panel panel-default">
        <table id="bidTable" class="table table-hover">
          <thead>
            <th></th>
            <template repeat="{{ item in items }}" >
              <th>{{item.name}}({{item.price}})</th>
            </template>
            <th>Price</th>
          </thead>

          <tbody id="tbody">
            <tr>
            <td>Quantity</td>
            <template repeat="{{ item in items }}"> 
                <td>{{item.quantity}}</td>
            </template>
            <td>N/A</td>
            </tr>

          </tbody>
        </table>
        <button id="addPackage" on-click="{{addPackage}}">+</button>
    </div>
  </template>

<!--   <input id="yamount{{item.ID}}" type="text" class="form-control" on-keyup="{{validate}}">
                      <p id="yamount_tips{{item.ID}}" class="tips"></p>
 -->
  <script>
    Polymer('auction-cca-phase2-table',{
      numOfPackages: 0,

      addPackage: function () {
        var tr = document.createElement("tr");
        var td1 = document.createElement("td");
        td1.innerHTML = "package " + this.numOfPackages;
        
        tr.appendChild(td1);
        for ( var i=0; i<this.items.length; i++ ) {
          var td = document.createElement("td");
          var id = "amount_" + this.numOfPackages + "_" + i;
          td.innerHTML = "<input id=" + id + " type='text' class='form-control' on-keyup='{{validate}}'><p id= " + id + "tip" +" class='tips'></p>";
          tr.appendChild(td);
        }
        var tdx = document.createElement("td");
	var tdxid = "price_" + this.numOfPackages;
        tdx.innerHTML = "<input id=" + tdxid + " type='text' class='form-control' on-keyup='{{validate}}'><p id= " + tdxid + "tip" +" class='tips'></p>";
        tr.appendChild(tdx);
        this.$.tbody.appendChild(tr);
        this.numOfPackages++;
      },

      getPackages: function() {

        var packageList = [];
        for ( var i=0; i < this.numOfPackages; i++ ) {
          var curr_package = {};
	  curr_package.combination = [];
          for ( var j=0; j< this.items.length; j++ ) {
            var it = {};
            var id = "amount_" + i + "_" + j;
            it.ID = this.items[j].ID;
            it.name = this.items[j].name;
            it.amount = amountTestAndSet(this, id, this.items[j].quantity);
            curr_package.combination.push(it);
          }
	  var priceId = "price_" + i;
	  curr_package.price = priceTestAndSet(this, priceId);
          packageList.push(curr_package);
         
        }
        console.log("Packages", packageList);
        return packageList;

        function amountTestAndSet(self, id, quantity) {
          console.log(id);
          var amount = self.$.tbody.querySelector("#" + id).value;
          var re = /^[0-9]+$/;
          if ( ! re.test(amount)  ||  parseInt(amount) > parseInt(quantity) ) {
            return "0";
          } else {
            return amount;
          }
        }
	
	function priceTestAndSet(self, id) {
	  var pkgPrice = self.$.tbody.querySelector("#" + id).value;
	  return pkgPrice;
	}
      },

      validate: function() {

        // for ( var i=0; i < this.numOfPackages; i++ ) {
        //   var package = [];
        //   for ( var j=0; j< this.items.length ) {
        //     var it = {};
        //     var id = "amount_" + i + "_" + j;
        //     it.amount = testAndSet(this, id, this.items[j].quantity);
        //     package.push(it);
        //   }
        //   packageList.push(package);
         
        // }

        // for ( i=0; i < this.items.length; i++ ) {
        //   id = this.items[i].ID;
        //   amount = this.items[i].quantity;
        //   yamount = this.$.tbody.querySelector("#yamount" + id).value;
        //   tips = this.$.tbody.querySelector("#yamount_tips" + id);

        //   hideTips(tips);
        //   if ( N2S(yamount).length != 0 ) {
        //     var re = /^[0-9]+$/;
        //     if ( ! re.test(yamount) ) {
        //       showTips(tips, "please enter a positive number");
        //     }
        //     if ( S2N(amount) < S2N(yamount) ) {
        //       showTips(tips, "too much");
        //     }
        //   }
        // } 

        // helper functions
        function S2N(str) {
          return parseInt(str);
        }

        function N2S(number) {
          if ( typeof number == "number" ) {
            return number.toString();
          }
          return number;
        }

        function showTips(tip, str) {
          tip.innerHTML = str;
          tip.style.display = "block";
          
        }

        function hideTips(tip) {
          tip.style.display = "none";
          
        }
      }
    });
  </script>
</polymer-element>
